bootstrap: docker
from: ubuntu:24.04

%environment
    export PYTHONDONTWRITEBYTECODE=1
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/miniconda3/lib

%post
    # Install wget
    apt update -y && apt install -y wget gpg
    
    # Install rocm
    # Make the directory if it doesn't exist yet.
    # This location is recommended by the distribution maintainers.
    mkdir --parents --mode=0755 /etc/apt/keyrings

    # Download the key, convert the signing-key to a full
    # keyring required by apt and store in the keyring directory
    wget https://repo.radeon.com/rocm/rocm.gpg.key -O - | \
        gpg --dearmor | tee /etc/apt/keyrings/rocm.gpg > /dev/null
    echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/6.2.2 noble main" \
        | tee --append /etc/apt/sources.list.d/rocm.list
    echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/amdgpu/6.2.2/ubuntu noble main" \
        | tee --append /etc/apt/sources.list.d/amdgpu.list
    echo 'Package: *\nPin: release o=repo.radeon.com\nPin-Priority: 600' > /etc/apt/preferences.d/rocm-pin-600
    cat /etc/apt/preferences.d/rocm-pin-600
    apt update
    apt install -y rocm-hip-sdk libdrm-amdgpu-common

    # Install miniconda
    export CONDA_PATH=/opt/miniconda3
    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash ./Miniconda3-latest-Linux-x86_64.sh -b -p $CONDA_PATH

    export WITH_CONDA=". $CONDA_PATH/bin/activate"
    echo "export WITH_CONDA=\"${WITH_CONDA}\"" >> $SINGULARITY_ENVIRONMENT
    $WITH_CONDA

    # Install WarpX build dependencies
    conda activate
    conda install -c conda-forge blaspp boost ccache cmake compilers git "heffte=*=mpi_mpich*" lapackpp "openpmd-api=*=mpi_mpich*" openpmd-viewer python make numpy pandas scipy yt "fftw=*=mpi_mpich*" pkg-config matplotlib mamba mpich mpi4py ninja pip virtualenv
    
    # Clean up the installation packages
    rm ./Miniconda3-latest-Linux-x86_64.sh
    rm -rf /var/lib/apt/lists/*
    pip cache purge
    conda clean --all
